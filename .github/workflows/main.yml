name: Create Secure Windows RDP

on:
  workflow_dispatch:

jobs:
  create-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Install Tailscale
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "tailscale-setup.exe"
          Start-Process -FilePath "tailscale-setup.exe" -ArgumentList "/S" -Wait
          Remove-Item "tailscale-setup.exe" -Force

      - name: Connect to Tailscale
        shell: pwsh
        run: |
          tailscale up --authkey ${{ secrets.TS_AUTHKEY }} `
                       --hostname "github-rdp-${{ github.run_id }}" `
                       --accept-routes --accept-dns

      - name: Enable RDP + Set Credentials
        shell: pwsh
        run: |
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
          net user runneradmin /active:yes
          net user runneradmin "@SecureRDP2026"   # â† Ø±Ù…Ø² Ø¯Ù„Ø®ÙˆØ§Ù‡Øª Ø±Ùˆ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø°Ø§Ø±

      - name: Verify RDP Port
        shell: pwsh
        run: |
          if (Get-NetTCPConnection -LocalPort 3389 -ErrorAction SilentlyContinue) {
              Write-Host "âœ… Ù¾ÙˆØ±Øª 3389 Ø¨Ø§Ø² Ùˆ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª" -ForegroundColor Green
          } else {
              Write-Host "âš ï¸ Ù¾ÙˆØ±Øª 3389 Ø¨Ø§Ø² Ù†Ø´Ø¯" -ForegroundColor Red
          }

      - name: RDP Connection Info
        shell: pwsh
        run: |
          Write-Host "`n[=============================================================]" -ForegroundColor Magenta
          Write-Host "                  ğŸ” Secure Windows RDP is READY!                  " -ForegroundColor Cyan
          Write-Host "[=============================================================]`n" -ForegroundColor Magenta

          $tsIP = (tailscale ip -4) 2>$null
          if ($tsIP) {
              Write-Host "ğŸŒ Tailscale IP Address : " -NoNewline -ForegroundColor Green
              Write-Host $tsIP -ForegroundColor White
          } else {
              Write-Host "âš ï¸ Tailscale IP Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯" -ForegroundColor Yellow
          }

          Write-Host "ğŸ‘¤ Username               : " -NoNewline -ForegroundColor Green
          Write-Host "runneradmin" -ForegroundColor White

          Write-Host "ğŸ”‘ Password               : " -NoNewline -ForegroundColor Green
          Write-Host "@SecureRDP2026" -ForegroundColor White

          Write-Host "`nğŸ“Œ Ù†Ø­ÙˆÙ‡ Ø§ØªØµØ§Ù„:" -ForegroundColor Yellow
          Write-Host "   1. Tailscale Ø±Ùˆ Ù†ØµØ¨ Ú©Ù† â†’ https://tailscale.com/download" -ForegroundColor White
          Write-Host "   2. Ø¨Ø§ Ø§Ú©Ø§Ù†Øª Ø®ÙˆØ¯Øª Ù„Ø§Ú¯ÛŒÙ† Ú©Ù†" -ForegroundColor White
          Write-Host "   3. ØªÙˆÛŒ RDP Ø¨Ø§ IP Ø¨Ø§Ù„Ø§ ÙˆØµÙ„ Ø´Ùˆ" -ForegroundColor White

          Write-Host "`nâœ… Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Øª! Ø¨Ø±Ùˆ Ø­Ø§Ù„Ø´Ùˆ Ø¨Ø¨Ø± ğŸ˜" -ForegroundColor Green
          Write-Host "[=============================================================]`n" -ForegroundColor Magenta

      - name: Keep Runner Alive
        shell: pwsh
        run: |
          Write-Host "Runner Ø²Ù†Ø¯Ù‡ Ù…ÙˆÙ†Ø¯... (ØªØ§ Û¶ Ø³Ø§Ø¹Øª)" -ForegroundColor Cyan
          Start-Sleep -Seconds 21600
