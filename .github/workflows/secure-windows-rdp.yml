name: Create Secure Windows RDP

on:
  workflow_dispatch:

jobs:
  create-rdp:
    runs-on: windows-latest
    timeout-minutes: 360   # Ø­Ø¯Ø§Ú©Ø«Ø± Û¶ Ø³Ø§Ø¹Øª (Ù…Ø­Ø¯ÙˆØ¯ÛŒØª GitHub)

    steps:
      # â”€â”€â”€â”€â”€â”€ Û±. Ù†ØµØ¨ Tailscale â”€â”€â”€â”€â”€â”€
      - name: Install Tailscale
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "tailscale-setup.exe"
          Start-Process -FilePath "tailscale-setup.exe" -ArgumentList "/S" -Wait
          Remove-Item "tailscale-setup.exe"

      # â”€â”€â”€â”€â”€â”€ Û². Ø§ØªØµØ§Ù„ Ø¨Ù‡ Tailscale â”€â”€â”€â”€â”€â”€
      - name: Connect to Tailscale
        shell: pwsh
        env:
          TS_AUTHKEY: ${{ secrets.TS_AUTHKEY }}   # â† Ø§ÛŒÙ†Ùˆ ØªÙˆ Secrets Ø¨Ø°Ø§Ø±
        run: |
          tailscale up --authkey \( env:TS_AUTHKEY --hostname "github-rdp- \){{ github.run_id }}" --accept-routes --accept-dns

      # â”€â”€â”€â”€â”€â”€ Û³. ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† RDP Ùˆ ØªÙ†Ø¸ÛŒÙ… Ú©Ø§Ø±Ø¨Ø± â”€â”€â”€â”€â”€â”€
      - name: Enable RDP + Set Credentials
        shell: pwsh
        run: |
          # ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† RDP
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389

          # Ú©Ø§Ø±Ø¨Ø± runneradmin Ø±Ùˆ ÙØ¹Ø§Ù„ Ùˆ Ø±Ù…Ø²Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†
          net user runneradmin /active:yes
          net user runneradmin "@SecureRDP2026"   # â† Ø§ÛŒÙ† Ø±Ù…Ø² Ø±Ùˆ Ø¹ÙˆØ¶ Ú©Ù† Ø§Ú¯Ù‡ Ø®ÙˆØ§Ø³ØªÛŒ

          Write-Host "RDP ÙØ¹Ø§Ù„ Ø´Ø¯ + Ø±Ù…Ø² ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯" -ForegroundColor Green

      # â”€â”€â”€â”€â”€â”€ Û´. Ú†Ú© Ú©Ø±Ø¯Ù† Ù¾ÙˆØ±Øª RDP â”€â”€â”€â”€â”€â”€
      - name: Verify RDP Port
        shell: pwsh
        run: |
          $port = Get-NetTCPConnection -LocalPort 3389 -ErrorAction SilentlyContinue
          if ($port) {
              Write-Host "âœ… Ù¾ÙˆØ±Øª 3389 Ø¨Ø§Ø² Ùˆ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§Ø³Øª" -ForegroundColor Green
          } else {
              Write-Host "âš ï¸ Ù¾ÙˆØ±Øª 3389 Ø¨Ø§Ø² Ù†Ø´Ø¯" -ForegroundColor Red
          }

      # â”€â”€â”€â”€â”€â”€ Ûµ. Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØªØµØ§Ù„ (Ø§ÛŒÙ† Ù‡Ù…ÙˆÙ† Ø¨Ø®Ø´ÛŒ Ø¨ÙˆØ¯ Ú©Ù‡ Ø®Ø·Ø§ Ù…ÛŒâ€ŒØ¯Ø§Ø¯) â”€â”€â”€â”€â”€â”€
      - name: RDP Connection Info
        shell: pwsh
        run: |
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          #                Secure Windows RDP - Connection Info
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

          Write-Host "`n[=============================================================]" -ForegroundColor Magenta
          Write-Host "                  ğŸ” Secure Windows RDP is READY!                  " -ForegroundColor Cyan
          Write-Host "[=============================================================]`n" -ForegroundColor Magenta

          # Ú¯Ø±ÙØªÙ† IP Tailscale
          $tsIP = (tailscale ip -4) 2>$null
          if ($tsIP) {
              Write-Host "ğŸŒ Tailscale IP Address : " -NoNewline -ForegroundColor Green
              Write-Host $tsIP -ForegroundColor White
          } else {
              Write-Host "âš ï¸  Tailscale IP Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯." -ForegroundColor Yellow
          }

          Write-Host "ğŸ‘¤ Username               : " -NoNewline -ForegroundColor Green
          Write-Host "runneradmin" -ForegroundColor White

          Write-Host "ğŸ”‘ Password               : " -NoNewline -ForegroundColor Green
          Write-Host "@SecureRDP2026" -ForegroundColor White

          Write-Host "`nğŸ“Œ Ù†Ø­ÙˆÙ‡ Ø§ØªØµØ§Ù„:" -ForegroundColor Yellow
          Write-Host "   1. Tailscale Ø±Ùˆ Ø±ÙˆÛŒ Ø¯Ø³ØªÚ¯Ø§Ù‡Øª Ù†ØµØ¨ Ú©Ù† â†’ https://tailscale.com/download" -ForegroundColor White
          Write-Host "   2. Ø¨Ø§ Ù‡Ù…ÙˆÙ† Ø§Ú©Ø§Ù†Øª Tailscale Ù„Ø§Ú¯ÛŒÙ† Ú©Ù†" -ForegroundColor White
          Write-Host "   3. ØªÙˆÛŒ Remote Desktop (RDP) IP Ø¨Ø§Ù„Ø§ Ø±Ùˆ Ø¨Ø²Ù†" -ForegroundColor White

          Write-Host "`nâœ… Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Øª! Ù„Ø°Øª Ø¨Ø¨Ø± ğŸ˜" -ForegroundColor Green
          Write-Host "[=============================================================]`n" -ForegroundColor Magenta

      # â”€â”€â”€â”€â”€â”€ Û¶. Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ† workflow Ø²Ù†Ø¯Ù‡ (ØªØ§ Û¶ Ø³Ø§Ø¹Øª) â”€â”€â”€â”€â”€â”€
      - name: Keep Runner Alive
        shell: pwsh
        run: |
          Write-Host "Runner Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§Ø³Øª... (Ø­Ø¯Ø§Ú©Ø«Ø± Û¶ Ø³Ø§Ø¹Øª)" -ForegroundColor Cyan
          Start-Sleep -Seconds 21600   # Û¶ Ø³Ø§Ø¹Øª
